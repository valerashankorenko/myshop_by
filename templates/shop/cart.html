{% extends "base.html" %}
{% load static %}

{% block title %}
Корзина
{% endblock %}

{% block content %}
<div class="container">
    <h2>Корзина {{ user.get_full_name }}</h2>
    {% if cart_items.count > 0 %}
    <ul id="cart-items">
        {% for cart_item in cart_items_with_total_price %}
        <li id="item-{{ cart_item.item.pk }}">
            {{ cart_item.item.product.name }} - <span class="item-quantity">{{ cart_item.item.quantity }}</span> шт. - 
            <span class="item-price">{{ cart_item.total_price }}</span> р.
            <button class="increase-button" data-id="{{ cart_item.item.pk }}">+</button>
            <button class="decrease-button" data-id="{{ cart_item.item.pk }}">-</button>
            <button class="delete-button" data-id="{{ cart_item.item.pk }}">Удалить</button>
        </li>
        {% endfor %}
    </ul>
    <p>Итого: <span id="total-quantity">{{ total_quantity }}</span> товаров</p>
    <p>Общая сумма: <span id="total-price">{{ total_price }}</span> р.</p>
    <form action="{% url 'shop:clear_cart' %}" method="post">
        {% csrf_token %}
        <button type="submit">Очистить корзину</button>
    </form>
    {% else %}
        <p>Ваша корзина пуста.</p>
    {% endif %}
</div>
<script>
    document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.getAttribute('data-id');
            fetch(`/cart/delete/${itemId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    document.getElementById(`item-${itemId}`).remove(); 
                    document.getElementById('total-quantity').innerText = data.total_quantity;
                    document.getElementById('total-price').innerText = data.total_price.toFixed(2) + ' р.';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    document.querySelectorAll('.increase-button').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.getAttribute('data-id');
            fetch(`/cart/increase/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const quantityElement = document.querySelector(`#item-${itemId} .item-quantity`);
                    const priceElement = document.querySelector(`#item-${itemId} .item-price`);

                    // Обновляем количество и общую сумму товара
                    quantityElement.innerText = data.new_quantity;
                    priceElement.innerText = (data.new_quantity * data.product_price).toFixed(2) + ' р.';

                    // Обновляем общую сумму и количество в корзине
                    document.getElementById('total-quantity').innerText = data.total_quantity;
                    document.getElementById('total-price').innerText = data.total_price.toFixed(2) + ' р.';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    document.querySelectorAll('.decrease-button').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.getAttribute('data-id');
            fetch(`/cart/decrease/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const quantityElement = document.querySelector(`#item-${itemId} .item-quantity`);
                    const priceElement = document.querySelector(`#item-${itemId} .item-price`);

                    // Обновляем количество и общую сумму товара
                    quantityElement.innerText = data.new_quantity;
                    priceElement.innerText = (data.new_quantity * data.product_price).toFixed(2) + ' р.';

                    // Обновляем общую сумму и количество в корзине
                    document.getElementById('total-quantity').innerText = data.total_quantity;
                    document.getElementById('total-price').innerText = data.total_price.toFixed(2) + ' р.';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
</script>
{% endblock %}